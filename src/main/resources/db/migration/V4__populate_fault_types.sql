-- Заполняем таблицу fault_types неисправностями для электромеханических устройств (категория 1)
INSERT INTO fault_types (code, name, description, device_category_id, coverage_requirement, gost_reference) VALUES
-- Электромеханические устройства (категория 1)
('F1.1', 'Не включение', 'Устройство не включается при подаче управляющего сигнала', 1, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.2'),
('F1.2', 'Не отключение', 'Устройство не отключается при снятии управляющего сигнала', 1, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.2'),
('F1.3', 'Приваренные контакты', 'Контактная группа приварилась в одном из положений', 1, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.2'),
('F1.4', 'Отсутствует принудительное управление контактами', 'Невозможность принудительного переключения контактов', 1, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.2'),
('F1.5', 'Отсутствует принудительное включение', 'Невозможность принудительного включения', 1, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.2'),

-- Дискретные аппаратные средства (категория 2)
('F2.1', 'Константный отказ (1)', 'Постоянно активное состояние', 2, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.3'),
('F2.2', 'Константный отказ (0)', 'Постоянно неактивное состояние', 2, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.3'),
('F2.3', 'Константный отказ адреса', 'Некорректная адресация', 2, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.3'),
('F2.4', 'Константный отказ данных', 'Некорректные данные', 2, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.3'),
('F2.5', 'Отказы типа отклонений при постоянном токе', 'Отклонения параметров от нормы', 2, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.3'),
('F2.6', 'Отказы типа колебаний при постоянном токе', 'Колебания параметров', 2, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.3'),

-- Устройства обработки (категория 3)
('F3.1', 'Неверное кодирование команды', 'Некорректное декодирование команд', 3, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),
('F3.2', 'Невыполнение команды', 'Игнорирование команд', 3, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),
('F3.3', 'Изменение информации', 'Некорректное хранение данных', 3, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),
('F3.4', 'Изменение адресов', 'Некорректная адресация', 3, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),
('F3.5', 'Отсутствует определение предполагаемого отказа', 'Не определяется отказ', 3, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),

-- Постоянная память (4.1)
('F4.1', 'Константный отказ данных или адресов', 'Постоянная ошибка в данных или адресации памяти', 4, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.5'),
('F4.2', 'Неисправности данных и адресов при постоянном токе', 'Ошибки в данных и адресации из-за проблем с питанием', 4, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.5'),
('F4.3', 'Все отказы, влияющие на данные в памяти', 'Любые отказы, приводящие к искажению или потере данных', 4, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.5'),

-- Устройство обработки прерываний (категория 5)
('F5.1', 'Отсутствуют прерывания', 'Не генерируются прерывания', 5, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.5'),
('F5.2', 'Непрерывные прерывания', 'Постоянная генерация прерываний', 5, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.5'),
('F5.3', 'Пересечение прерываний', 'Наложение прерываний', 5, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.5'),
('F5.4', 'Отдельные компоненты не инициализируют состояние возврата', 'Некорректное восстановление состояния', 5, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.5'),

-- Память с произвольным доступом (категория 6)
('F6.1', 'Константный отказ данных или адресов', 'Постоянная ошибка в данных или адресах памяти', 6, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.6'),
('F6.2', 'Неисправности данных и адресов при постоянном токе', 'Ошибки, вызванные проблемами с питанием', 6, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.6'),
('F6.3', 'Изменение информации из-за исправимых ошибок', 'Искажение данных из-за сбоев, которые могут быть исправлены', 6, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.6'),
('F6.4', 'Перекрестные помехи в ячейках памяти', 'Взаимное влияние ячеек памяти друг на друга', 6, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.6'),
('F6.5', 'Отсутствие адресации', 'Обращение к несуществующей ячейке памяти', 6, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.6'),
('F6.6', 'Неверная адресация', 'Обращение к неправильной ячейке памяти', 6, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.6'),
('F6.7', 'Множественная адресация', 'Одновременное обращение к нескольким ячейкам памяти', 6, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.6'),

-- Устройство синхронизации (категория 10)
('F10.1', 'Нижняя гармоника', 'Пониженная частота', 10, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.11'),
('F10.2', 'Верхняя гармоника', 'Повышенная частота', 10, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.11'),
('F10.3', 'Неверная частота', 'Отклонение частоты от номинала', 10, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.11'),
('F10.4', 'Неустойчивость периода синхронизации', 'Дрейф частоты', 10, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.11'),

-- Устройство связи (категория 11)
('F11.1', 'Неверные данные', 'Искажение передаваемых данных', 11, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.12'),
('F11.2', 'Неверные адреса', 'Некорректная адресация', 11, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.12'),
('F11.3', 'Отсутствует передача данных', 'Обрыв канала связи', 11, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.12'),
('F11.4', 'Неверное время передачи', 'Нарушение временных характеристик', 11, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.12'),
('F11.5', 'Неверная последовательность передачи', 'Нарушение порядка передачи', 11, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.12'),

-- Датчики (категория 12)
('F12.1', 'Константный отказ', 'Постоянное значение на выходе', 12, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.13'),
('F12.2', 'Дрейф', 'Медленное изменение показаний', 12, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.13'),
('F12.3', 'Колебания', 'Нестабильные показания', 12, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.13'),

-- Исполнительные элементы (категория 13)
('F13.1', 'Константный отказ', 'Постоянное состояние на выходе', 13, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.14'),
('F13.2', 'Дрейф', 'Медленное изменение выходного сигнала', 13, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.14'),
('F13.3', 'Колебания', 'Нестабильный выходной сигнал', 13, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.14'),

-- Общая шина (14.1)
('F14.1', 'Константный отказ адресов', 'Постоянная ошибка адресации на шине', 14, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.3'),
('F14.2', 'Временная потеря работоспособности', 'Кратковременные сбои на шине', 14, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.3'),

-- Диспетчер памяти (14.2)
('F14.3', 'Неверное декодирование адреса', 'Ошибки при преобразовании адресов', 14, 'MEDIUM', 'ГОСТ Р МЭК 61508-2-2012 А.8'),
('F14.4', 'Изменение адресов из-за ошибок в регистрах', 'Кратковременные ошибки в регистрах диспетчера памяти', 14, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.8'),

-- Прямой доступ к памяти (14.3)
('F14.5', 'Отсутствие доступа к данным', 'Невозможность чтения/записи данных', 14, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.9'),
('F14.6', 'Неверное время доступа', 'Нарушение временных характеристик доступа', 14, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.9'),

-- Управление доступом к шине (14.4)
('F14.7', 'Отказ сигналов управления доступом', 'Нарушение арбитража доступа к шине', 14, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.3');

-- Добавляем неисправности для процессора (ID категории 15)
INSERT INTO fault_types (code, name, description, device_category_id, coverage_requirement, gost_reference) VALUES
-- Регистры и внутреннее ОЗУ (15.1)
('F15.1', 'Константный отказ данных', 'Постоянная ошибка в данных регистров', 15, 'LOW', 'ГОСТ Р МЭК 61508-2-2012 А.4'),
('F15.2', 'Перекрестные помехи в ячейках памяти', 'Взаимное влияние ячеек памяти', 15, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),

-- Устройство кодирования и выполнения (15.2)
('F15.3', 'Неверное кодирование команд', 'Ошибки при декодировании инструкций', 15, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),
('F15.4', 'Невыполнение команд', 'Пропуск выполнения инструкций', 15, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),

-- Устройство вычисления адреса (15.3)
('F15.5', 'Ошибки вычисления адреса', 'Некорректный расчет адресов', 15, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),

-- Счетчик команд и указатель стека (15.4)
('F15.6', 'Сбой счетчика команд', 'Некорректное изменение адреса следующей команды', 15, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4'),
('F15.7', 'Ошибка указателя стека', 'Некорректная работа стека вызовов', 15, 'HIGH', 'ГОСТ Р МЭК 61508-2-2012 А.4');

-- Связываем методы диагностики с неисправностями
-- Для примера, свяжем некоторые методы с неисправностями
-- В реальном приложении эти связи должны быть более детальными
MERGE INTO diagnostic_method_faults d
    USING (
        SELECT
            dm.id as dm_id,
            ft.id as ft_id,
            CASE
                WHEN dm.coverage_level = 'HIGH' THEN 'HIGH'
                WHEN dm.coverage_level = 'MEDIUM' THEN 'MEDIUM'
                ELSE 'LOW'
                END as eff
        FROM diagnostic_methods dm
                 CROSS JOIN fault_types ft
        WHERE
           -- Связываем методы с неисправностями из соответствующих категорий
            (dm.device_category_id = 1 AND ft.device_category_id = 1) OR  -- Электромеханические устройства
            (dm.device_category_id = 2 AND ft.device_category_id = 2) OR  -- Дискретные аппаратные средства
            (dm.device_category_id = 3 AND ft.device_category_id = 3) OR  -- Устройства обработки
            (dm.device_category_id = 4 AND ft.device_category_id = 4) OR  -- Устройство обработки прерываний
            (dm.device_category_id = 5 AND ft.device_category_id = 5) OR  -- Постоянная память
            (dm.device_category_id = 6 AND ft.device_category_id = 6) OR  -- Память с произвольным доступом
            (dm.device_category_id = 10 AND ft.device_category_id = 10) OR -- Устройство синхронизации
            (dm.device_category_id = 11 AND ft.device_category_id = 11) OR -- Устройство связи
            (dm.device_category_id = 12 AND ft.device_category_id = 12) OR -- Датчики
            (dm.device_category_id = 13 AND ft.device_category_id = 13) OR -- Исполнительные элементы
            (dm.device_category_id = 14 AND ft.device_category_id = 14) OR -- Шина
            (dm.device_category_id = 15 AND ft.device_category_id = 15)    -- Процессор
    ) s
    ON (d.diagnostic_method_id = s.dm_id AND d.fault_type_id = s.ft_id)
    WHEN NOT MATCHED THEN
        INSERT (diagnostic_method_id, fault_type_id, effectiveness)
            VALUES (s.dm_id, s.ft_id, s.eff);

-- Обновляем последовательности, чтобы избежать конфликтов при вставке
-- H2 uses a different syntax for identity columns
-- The sequences will be managed automatically by H2
