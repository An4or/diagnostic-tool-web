<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layouts/base}"
      th:with="title=${profile.id == null ? 'Add Profile' : 'Edit Profile'}">
<head>
    <title th:text="${profile.id == null ? 'Add Profile' : 'Edit Profile'} + ' - Diagnostic Tool'">Profile Form</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
</head>
<body>
    <div layout:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi me-2" th:classappend="${profile.id == null} ? 'bi-person-plus' : 'bi-person-lines-fill'"></i>
                <span th:text="${profile.id == null} ? 'Add New Profile' : 'Edit Profile'"></span>
            </h1>
            <a th:href="@{/profiles}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to List
            </a>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <form th:action="${profile.id == null} ? @{/profiles} : @{/profiles/__${profile.id}__}" 
                      th:object="${profile}" 
                      method="post"
                      th:enctype="${'multipart/form-data'}">
                    
                    <!-- CSRF Token -->
                    <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    
                    <!-- Method Spoofing for PUT -->
                    <input type="hidden" name="_method" th:if="${profile.id != null}" value="put" />
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Profile Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" th:field="*{name}" required />
                            <div class="invalid-feedback">Please provide a profile name.</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" th:field="*{description}" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12 device-selection-container">
                            <label class="form-label mb-3">Select Devices</label>
                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="list-group">
                                    <div th:each="device : ${allDevices}" class="list-group-item border-0 p-2">
                                        <div class="form-check">
                                            <input class="form-check-input device-checkbox" 
                                                   type="checkbox" 
                                                   th:value="${device.id}"
                                                   th:id="'device-' + ${device.id}"
                                                   th:name="deviceIds"
                                                   th:checked="${#lists.contains(profile?.deviceIds, device.id)}">
                                            <label class="form-check-label w-100" 
                                                   th:for="'device-' + ${device.id}"
                                                   th:text="${device.name + ' (' + device.category.name + ')'}">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text">Select one or more devices for this profile</div>
                            <div class="invalid-feedback">Please select at least one device</div>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for device methods will be added here by JavaScript -->
                    <div id="methodFields"></div>
                    
                    <!-- Device Details Section -->
                    <div id="deviceDetailsContainer" class="mb-4">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a th:href="@{/profiles}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i> 
                            <span th:text="${profile.id == null} ? 'Create Profile' : 'Update Profile'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <!-- Select2 JS -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        
        <script th:inline="javascript">
            // Store device data for quick access
            const devicesData = {
                /*[[${#lists.toList(allDevices)}]]*/
            };
            
            // Track selected devices and their diagnostic methods
            const selectedDevices = new Map();
            
            // Update device details section based on selected devices
            window.updateDeviceDetails = function() {
                const selectedCheckboxes = document.querySelectorAll('.device-checkbox:checked');
                const selectedDeviceIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);
                const container = document.getElementById('deviceDetailsContainer');
                const methodFields = document.getElementById('methodFields');
                
                container.innerHTML = '';
                if (methodFields) methodFields.innerHTML = '';
                
                if (selectedDeviceIds.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No devices selected</div>';
                    return;
                }
                
                // Group devices by category for better organization
                const devicesByCategory = {};
                selectedDeviceIds.forEach(deviceId => {
                    const device = devicesData[deviceId];
                    if (device) {
                        if (!devicesByCategory[device.category.id]) {
                            devicesByCategory[device.category.id] = {
                                category: device.category,
                                devices: []
                            };
                        }
                        devicesByCategory[device.category.id].devices.push(device);
                    }
                });
                
                // Render each category section
                Object.values(devicesByCategory).forEach(categoryData => {
                    const category = categoryData.category;
                    const devices = categoryData.devices;
                    
                    const categorySection = $(`
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">${category.name}</h5>
                                <small class="text-muted">${category.description || ''}</small>
                            </div>
                            <div class="card-body">
                                <div class="row g-3" id="category-${category.id}-devices">
                                    <!-- Devices will be added here -->
                                </div>
                            </div>
                        </div>
                    `);
                    
                    const devicesContainer = categorySection.find(`#category-${category.id}-devices`);
                    
                    // Add each device in this category
                    devices.forEach(device => {
                        const deviceCard = $(`
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${device.name}</h6>
                                        <span class="badge bg-primary">${device.architectureType || 'N/A'}</span>
                                    </div>
                                    <div class="card-body">
                                        <p class="small text-muted">${device.description || 'No description available'}</p>
                                        <div class="mt-2">
                                            <label class="form-label small fw-bold">Diagnostic Methods:</label>
                                            <div id="methods-${device.id}" class="mt-1">
                                                <!-- Methods will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                        
                        devicesContainer.append(deviceCard);
                        loadDeviceMethods(device.id);
                    });
                    
                    container.append(categorySection);
                });
            }
            
            // Load methods for a specific device
            function loadDeviceMethods(deviceId) {
                const device = devicesData[deviceId];
                if (!device || !device.category || !device.category.diagnosticMethods) return;
                
                const methodsContainer = $(`#methods-${deviceId}`);
                methodsContainer.empty();
                
                // Get methods for this device's category
                const methods = device.category.diagnosticMethods || [];
                
                if (methods.length === 0) {
                    methodsContainer.html('<div class="text-muted small">No diagnostic methods available for this device</div>');
                    return;
                }
                
                // Create checkboxes for each method
                methods.forEach(method => {
                    const methodId = `method-${deviceId}-${method.id}`;
                    const isChecked = device.selectedMethods && device.selectedMethods.some(m => m.id === method.id);
                    
                    const methodElement = $(`
                        <div class="form-check">
                            <input class="form-check-input method-checkbox" 
                                   type="checkbox" 
                                   id="${methodId}"
                                   value="${method.id}"
                                   data-device-id="${deviceId}"
                                   ${isChecked ? 'checked' : ''}>
                            <label class="form-check-label small" for="${methodId}">
                                ${method.name}
                                ${method.coverage ? `<span class="badge bg-info">Coverage: ${method.coverage}%</span>` : ''}
                            </label>
                            ${method.description ? `<div class="form-text small">${method.description}</div>` : ''}
                        </div>
                    `);
                    
                    methodsContainer.append(methodElement);
                });
                
                // Add change handler for method checkboxes
                methodsContainer.find('.method-checkbox').on('change', function() {
                    updateMethodSelection($(this).data('device-id'));
                });
                
                // Initial update
                updateMethodSelection(deviceId);
            }
            
            // Update method selection for a device
            function updateMethodSelection(deviceId) {
                const selectedMethods = [];
                $(`#methods-${deviceId} .method-checkbox:checked`).each(function() {
                    selectedMethods.push($(this).val());
                });
                
                // Update hidden field for form submission
                $(`#device-methods-${deviceId}`).remove();
                if (selectedMethods.length > 0) {
                    $('#methodFields').append(
                        `<input type="hidden" name="deviceMethods[${deviceId}]" id="device-methods-${deviceId}" value="${selectedMethods.join(',')}">`
                    );
                }
            }
            
            // Form validation and initialization
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.querySelector('form');
                
                if (form) {
                    // Initialize devicesData with actual device data first
                    const devices = /*[[${#lists.toList(allDevices)}]]*/ [];
                    devices.forEach(device => {
                        devicesData[device.id] = device;
                    });
                    
                    // Add event listeners to device checkboxes
                    document.addEventListener('change', function(e) {
                        if (e.target.classList.contains('device-checkbox')) {
                            // Clear any previous validation messages
                            const existingMessages = document.querySelectorAll('.device-selection-container .invalid-feedback');
                            existingMessages.forEach(msg => msg.remove());
                            updateDeviceDetails();
                        }
                    });
                    
                    // Form submission handler - using onsubmit to ensure it runs before the form submits
                    form.onsubmit = function(event) {
                        // Reset any previous validation states
                        form.classList.remove('was-validated');
                        
                        // Check if at least one device is selected
                        const selectedDevices = document.querySelectorAll('.device-checkbox:checked');
                        if (selectedDevices.length === 0) {
                            event.preventDefault();
                            event.stopPropagation();
                            
                            // Remove any existing validation messages
                            const existingMessages = document.querySelectorAll('.device-selection-container .invalid-feedback');
                            existingMessages.forEach(msg => msg.remove());
                            
                            // Add new validation message
                            const validationMessage = document.createElement('div');
                            validationMessage.className = 'invalid-feedback d-block';
                            validationMessage.textContent = 'Please select at least one device';
                            const deviceContainer = document.querySelector('.device-selection-container');
                            if (deviceContainer) {
                                deviceContainer.appendChild(validationMessage);
                            }
                            
                            // Mark form as invalid
                            form.classList.add('was-validated');
                            return false;
                        }
                        
                        // Check other form validations
                        if (!form.checkValidity()) {
                            event.preventDefault();
                            event.stopPropagation();
                            form.classList.add('was-validated');
                            return false;
                        }
                        
                        // If we get here, form is valid and will submit
                        return true;
                    };
                    
                    // Initial update of device details
                    updateDeviceDetails();
                }
                
                // Update device details based on selected devices
                function updateDeviceDetails() {
                    const selectedDevices = Array.from(document.querySelectorAll('.device-checkbox:checked'));
                    const container = document.getElementById('deviceDetailsContainer');
                    
                    // Clear previous content
                    container.innerHTML = '';
                    
                    // Process each selected device
                    selectedDevices.forEach(device => {
                        const deviceId = device.value;
                        const deviceData = devicesData[deviceId];
                        
                        if (!deviceData) return;
                        
                        // Create device card
                        const card = document.createElement('div');
                        card.className = 'card mb-3';
                        
                        // Card header with device name and architecture selector
                        card.innerHTML = `
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">${device.name}</h5>
                                <div class="architecture-selector">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <input type="radio" class="btn-check" name="architecture_${deviceId}" 
                                               id="arch_1oo1_${deviceId}" value="ONE_OUT_OF_ONE" 
                                               ${device.architectureType === 'ONE_OUT_OF_ONE' ? 'checked' : ''}
                                               onchange="updateDiagnosticMethods('${deviceId}')">
                                        <label class="btn btn-outline-primary" for="arch_1oo1_${deviceId}">1oo1</label>
                                        
                                        <input type="radio" class="btn-check" name="architecture_${deviceId}" 
                                               id="arch_1oo2_${deviceId}" value="ONE_OUT_OF_TWO"
                                               ${device.architectureType === 'ONE_OUT_OF_TWO' ? 'checked' : ''}
                                               onchange="updateDiagnosticMethods('${deviceId}')">
                                        <label class="btn btn-outline-primary" for="arch_1oo2_${deviceId}">1oo2</label>
                                        
                                        <input type="radio" class="btn-check" name="architecture_${deviceId}" 
                                               id="arch_2oo3_${deviceId}" value="TWO_OUT_OF_THREE"
                                               ${device.architectureType === 'TWO_OUT_OF_THREE' ? 'checked' : ''}
                                               onchange="updateDiagnosticMethods('${deviceId}')">
                                        <label class="btn btn-outline-primary" for="arch_2oo3_${deviceId}">2oo3</label>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="diagnostic-methods" id="methods_${deviceId}">
                                    <!-- Will be populated by updateDiagnosticMethods -->
                                </div>
                                <div class="mt-3 d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="me-2">Coverage:</span>
                                        <span id="methods_${deviceId}_coverage" class="badge bg-secondary">0%</span>
                                    </div>
                                    <div>
                                        <span id="methods_${deviceId}_compliance" class="badge bg-secondary">
                                            <i class="bi bi-question-circle me-1"></i> Check Compliance
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(card);
                        
                        // Initialize diagnostic methods for this device
                        updateDiagnosticMethods(deviceId);
                        
                        // Add event listener for architecture changes
                        document.querySelectorAll(`input[name="architecture_${deviceId}"]`).forEach(radio => {
                            radio.addEventListener('change', () => {
                                updateDiagnosticMethods(deviceId);
                            });
                        });
                    });
                };
                
                // Update diagnostic methods based on selected architecture
                window.updateDiagnosticMethods = function(deviceId) {
                    const methodsContainer = document.getElementById(`methods_${deviceId}`);
                    if (!methodsContainer) return;
                    
                    // Get selected architecture
                    const selectedArch = document.querySelector(`input[name="architecture_${deviceId}"]:checked`).value;
                    let numSlots = 1;
                    
                    // Determine number of slots based on architecture
                    switch(selectedArch) {
                        case 'ONE_OUT_OF_ONE':
                            numSlots = 1;
                            break;
                        case 'ONE_OUT_OF_TWO':
                            numSlots = 2;
                            break;
                        case 'TWO_OUT_OF_THREE':
                            numSlots = 3;
                            break;
                    }
                    
                    // Clear existing content
                    methodsContainer.innerHTML = '';
                    
                    // Create method selectors
                    for (let i = 0; i < numSlots; i++) {
                        const div = document.createElement('div');
                        div.className = 'mb-3';
                        div.innerHTML = `
                            <label class="form-label">Diagnostic Method ${i + 1}</label>
                            <select class="form-select method-select" 
                                    name="deviceMethods_${deviceId}" 
                                    data-device="${deviceId}" 
                                    data-slot="${i}">
                                <option value="">Select a method...</option>
                                <!-- Methods will be populated by AJAX -->
                            </select>
                        `;
                        methodsContainer.appendChild(div);
                        
                        // Initialize Select2 for this dropdown
                        $(div).find('select').select2({
                            theme: 'bootstrap-5',
                            width: '100%'
                        });
                        
                        // Load available methods for this device
                        loadDiagnosticMethods(deviceId, i);
                    }
                };
                
                // Load available diagnostic methods for a device
                function loadDiagnosticMethods(deviceId, slot) {
                    const select = document.querySelector(`select[data-device="${deviceId}"][data-slot="${slot}"]`);
                    if (!select) return;
                    
                    // Get selected architecture
                    const selectedArch = document.querySelector(`input[name="architecture_${deviceId}"]:checked`).value;
                    const profileId = document.querySelector('input[name="id"]')?.value || 'new';
                    
                    // Show loading state
                    select.disabled = true;
                    select.innerHTML = '<option value="">Loading methods...</option>';
                    
                    // Fetch methods from the API
                    fetch(`/api/profiles/${profileId}/devices/${deviceId}/available-methods?architecture=${selectedArch}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(methods => {
                            // Clear existing options
                            select.innerHTML = '<option value="">Select a method...</option>';
                            
                            // Add methods to select
                            methods.forEach(method => {
                                const option = document.createElement('option');
                                option.value = method.id;
                                option.textContent = method.name;
                                option.dataset.coverage = method.diagnosticCoverage || 0;
                                select.appendChild(option);
                            });
                            
                            // Enable the select
                            select.disabled = false;
                            
                            // Update coverage when selection changes
                            $(select).off('change').on('change', function() {
                                updateCoverage(deviceId);
                            });
                            
                            // Refresh Select2
                            $(select).trigger('change');
                            
                            // Update coverage after methods are loaded
                            updateCoverage(deviceId);
                        })
                        .catch(error => {
                            console.error('Error loading methods:', error);
                            select.innerHTML = '<option value="">Error loading methods</option>';
                        });
                }
                
                // Update coverage for a device
                function updateCoverage(deviceId) {
                    const coverageBadge = document.querySelector(`#methods_${deviceId}_coverage`);
                    if (!coverageBadge) return;
                    
                    // Get all selected method coverages
                    const coverages = [];
                    document.querySelectorAll(`select[data-device="${deviceId}"]`).forEach(select => {
                        if (select.value) {
                            const selectedOption = select.options[select.selectedIndex];
                            const coverage = parseFloat(selectedOption.dataset.coverage || 0);
                            if (!isNaN(coverage)) {
                                coverages.push(coverage / 100); // Convert to decimal
                            }
                        }
                    });
                    
                    // Calculate total coverage using the formula: 1 - ∏(1 - DC_i)
                    let totalCoverage = 0;
                    if (coverages.length > 0) {
                        const product = coverages.reduce((acc, coverage) => acc * (1 - coverage), 1);
                        totalCoverage = (1 - product) * 100; // Convert back to percentage
                    }
                    
                    // Update the UI
                    coverageBadge.textContent = `${totalCoverage.toFixed(2)}%`;
                    
                    // Update badge color based on coverage
                    coverageBadge.className = 'badge ' + (
                        totalCoverage >= 99 ? 'bg-success' :
                        totalCoverage >= 90 ? 'bg-warning' : 'bg-danger'
                    );
                    
                    // Check compliance with SIL requirements
                    checkCompliance(deviceId, totalCoverage);
                }
                
                // Check if the device meets SIL requirements based on coverage and architecture
                function checkCompliance(deviceId, coverage) {
                    const complianceBadge = document.querySelector(`#methods_${deviceId}_compliance`);
                    if (!complianceBadge) return;
                    
                    // Get selected architecture
                    const selectedArch = document.querySelector(`input[name="architecture_${deviceId}"]:checked`)?.value;
                    
                    // Check compliance based on architecture
                    let isCompliant = false;
                    switch(selectedArch) {
                        case 'ONE_OUT_OF_ONE':
                            isCompliant = coverage >= 99.0;
                            break;
                        case 'ONE_OUT_OF_TWO':
                            isCompliant = coverage >= 90.0;
                            break;
                        case 'TWO_OUT_OF_THREE':
                            isCompliant = coverage >= 60.0;
                            break;
                    }
                    
                    // Update the UI
                    if (isCompliant) {
                        complianceBadge.innerHTML = '<i class="bi bi-check-circle me-1"></i> SIL Compliant';
                        complianceBadge.className = 'badge bg-success';
                    } else {
                        complianceBadge.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i> Not Compliant';
                        complianceBadge.className = 'badge bg-danger';
                    }
                }
                
                // Loop over them and prevent submission
                    Array.prototype.slice.call(forms).forEach(function(form) {
                        form.addEventListener('submit', function(event) {
                            if (!form.checkValidity()) {
                                event.preventDefault();
                                event.stopPropagation();
                            }
                            
                            form.classList.add('was-validated');
                        }, false);
                    });
                })();
            });
        </script>
    </th:block>
</body>
</html>
